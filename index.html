<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>きょうなに作る？</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/jquery-2.1.3.min.js"></script>
    <link rel="stylesheet" href="css/style.css" />
    <style>
    h1 {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px; /* タイトルの高さを明示 */
      background-color: #38a169; /* 元の緑色 */
      padding: 10px;
      z-index: 1000; /* 他の要素の上に表示 */
    }

    body {
      padding-top: 70px; /* タイトルの高さ分の余白を確保し、裏に回り込むのを防ぐ */
    }
    ol {
      list-style-type: decimal !important;
      padding-left: 1rem !important;
    }
    </style>
  </head>

  <body
    class="w-full h-screen bg-gray-50 flex flex-col items-center justify-start min-h-screen p-4"
  >
  
      <div
      id="container"
      class="bg-pink-50 w-full max-w-md flex-grow p-6 rounded-lg shadow-lg text-center flex flex-col justify-center"
    >
      <!-- タイトル -->
      <h1
        class="text-2xl text-white font-bold p-[10px] bg-green-500 rounded shadow-xl p-4 sticky"
      >
        きょうなに作る？
      </h1>
      <!-- 初期画面 -->
      <div id="screen1" class="screen">
        <p class="text-lg font-bold"></p>
        <!-- メニュー検索ボタン -->
        <button
          onclick="goToScreen2()"
          class="mt-4 w-full px-4 py-2 bg-pink-500 text-white rounded hover:bg-green-300"
        >
          メニュー検索
        </button>
        <!-- 新規メニュー登録ボタン -->
        <button
          onclick="goToScreen4()"
          class="mt-4 w-full px-4 py-2 bg-pink-500 text-white rounded hover:bg-green-300"
        >
          新規メニュー登録
        </button>
                <!-- 日本人は料理頑張り過ぎ的な思いを込めたメッセージ -->
        <div id="" class="container mt-10 bg-white opacity-70">
          <h2 id="" class="font-bold">世界の食卓・・・ドイツのKaltes Essen</h2>
          <p id="" class="text-left px-2 text-justify indent-4">
            <span style="display: block"
              >冷たい食事という意味ですが、火を使わずに簡単に準備ができる軽めの食事をいいます。
              ハムやソーセージ、チーズとパンなどが主で、お好みで軽いサラダやピクルスなども。
              テーブルに並べ、家族がそれぞれ好きなものを取りながら、食事をします。<br
            /></span>
            <span style="display: block"
              >準備は、食材をテーブルに並べるだけ！買い物や下ごしらえの手間もありません。
              昼にしっかり食べ、朝夕は軽めに済ませる人が多いドイツですが、家事の負担を軽くし夜は家族でゆったりと過ごすためでもあります。</span
            >
          </p>
        </div>
      </div>

      <!-- メニュー検索画面 -->
      <div id="screen2" class="screen hidden">
        <p class="text-lg font-bold"></p>
        <div class="flex flex-col items-center space-y-4">
          <!-- 検索窓：入力フォーム -->
          <input
            type="text"
            id="searchWord"
            class="my-3 p-2"
            placeholder="検索ワードを入力"
          />
          <!-- 検索ボタン -->
          <button
            id="search"
            class="mt-4 w-full px-4 py-2 bg-pink-500 text-white rounded hover:bg-green-300"
          >
            検索
          </button>
          <!-- 検索ワードのクリアボタン -->
          <button
            id="wordClear"
            class="mt-4 w-full px-4 py-2 bg-pink-500 text-white rounded hover:bg-green-300"
          >
            検索ワードのクリア
          </button>
          <!-- 検索結果表示＋メニュー選択 -->
          <p id="resultContainer" class=""></p>

          <!-- 最初に戻るボタン -->
          <button
            onclick="goToScreen1()"
            class="mt-4 w-full px-4 py-2 bg-pink-500 text-white rounded hover:bg-green-300"
          >
            最初に戻る
          </button>
        </div>
      </div>
      
      <!-- メニュー表示画面 -->
      <div id="screen3" class="screen hidden">
        <p class="text-lg font-bold"></p>
        <!-- 選択したメニューの表示 -->
        <div id="menuDetails" class="hidden p-4 bg-white rounded shadow-lg">
          <!-- ここにJavaScriptでメニュー詳細情報が追加される -->
        </div>
        <!-- メニュー更新ボタン -->
        <button
          id=""
          class="mt-4 w-full px-4 py-2 bg-pink-500 text-white rounded hover:bg-green-300"
        >
          メニュー更新<<<工事中>>>
        </button>
        <!-- メニュー削除ボタン -->
        <button
          id=""
          class="mt-4 w-full px-4 py-2 bg-pink-500 text-white rounded hover:bg-green-300"
        >
          メニュー削除<<<工事中>>>
        </button>
        <!-- 検索画面に戻るボタン -->
        <button
          onclick="goToScreen2()"
          class="mt-4 w-full px-4 py-2 bg-pink-500 text-white rounded hover:bg-green-300"
        >
          検索に戻る
        </button>
        <!-- 最初に戻るボタン -->
        <button
          onclick="goToScreen1()"
          class="mt-4 w-full px-4 py-2 bg-pink-500 text-white rounded hover:bg-green-300"
        >
          最初に戻る
        </button>
      </div>

      <!-- 新規メニュー登録画面 -->
      <div id="screen4" class="screen hidden">
        <p class="text-lg font-bold"></p>
        <!-- 登録したいメニューの入力 -->
        <h2 class="mt-2 font-bold">メニューを登録してください</h2>
        <table class="gap-32">
          <tr class=""><td class="w-[240px] h-[50px] bg-gray-100 font-bold">タイトル</td>
            <td class="w-[360px]"><input type="text" id="titleInput" class="ml-[10px] w-[300px] p-[5px]" placeholder="メニュータイトルを入力"></td></tr>
          <tr class=""><td class="w-[240px] h-[50px] bg-gray-100 font-bold">人数</td>
            <td class="w-[360px]"><input type="number" id="servingsInput" class="ml-[10px] w-[300px] p-[5px]" placeholder="何人前かを数字で入力"></td></tr>
        </table>
        
        <table id="ingredientsTable" class="w-full max-w-lg mx-auto overflow-x-auto">
          <thead>
            <tr class="bg-gray-100">
              <th class="w-[200px] p-[5px]">食材・調味料</th>
              <th class="w-[200px] p-[5px]">分量</th>
              <th class="w-[100px] p-[5px]">単位</th>
              <th class="w-[80px] p-[5px]"></th> <!-- 削除ボタンの列 -->
            </tr>
          </thead>
          <tbody id="ingredientsBody">
            <!-- JavaScriptで追加される行 -->
          </tbody>
        </table>
        <button onclick="addIngredientRow()" class="mt-2 bg-pink-500 text-white px-3 py-2 rounded mx-auto block">追加</button>

        <table id="cooksTable" class="w-full max-w-lg mx-auto overflow-x-auto">
          <thead>
            <tr class="bg-gray-100">
              <th class="w-[500px] p-[5px]">調理工程</th>
              <th class="w-[80px] p-[5px]"></th> <!-- 削除ボタンの列 -->
            </tr>
          </thead>
          <tbody id="cooksBody">
            <!-- JavaScriptで追加される行 -->
          </tbody>
        </table>
        <button onclick="addCookRow()" class="mt-2 bg-pink-500 text-white px-3 py-2 rounded mx-auto block">追加</button>
        
        <!-- メニュー登録ボタン -->
        <button
          id="register"
          class="mt-4 w-full px-4 py-2 bg-pink-500 text-white rounded hover:bg-green-300"
        >
          メニュー登録
        </button>
        <!-- 最初に戻るボタン -->
        <button
          onclick="goToScreen1()"
          class="mt-4 w-full px-4 py-2 bg-pink-500 text-white rounded hover:bg-green-300"
        >
          最初に戻る
        </button>
      </div>
    </div>

    <footer
      class="w-full max-w-md p-1 bg-white rounded-lg shadow-lg text-center mt-2"
    >
      &copy; 2025 Izumi Yoshida<br />背景画像：freepik.com
    </footer>

    <script>
      /***********************************************************************************************
      グローバル変数定義
      ***********************************************************************************************/
      const recipes = JSON.parse(localStorage.getItem("recipes")) || [];

      /***********************************************************************************************
      初期メニュー登録：ローカルストレージへのセーブ
      ***********************************************************************************************/
      $(document).ready(function () {
        // ローカルストレージに "recipes" があるか確認
        if (!localStorage.getItem("recipes")) {
          // 初期データ
          const recipes = [
            {
              title: "厚焼き玉子",
              servings: 3,
              ingredients: [
                { ingredient: "卵", amount: 3, unit: "個" },
                { ingredient: "油", amount: "", unit: "適宜" },
                { ingredient: "砂糖", amount: 1, unit: "大さじ" },
                { ingredient: "醤油", amount: 1, unit: "小さじ" },
              ],
              cook: [
                "卵をボウルに割り入れ調味料入れ混ぜ合わせ、白身を断ち切る。",
                "卵を焼く前に、キッチンペーパーに油を吸わせ、焼く途中に油を補充するためのものを用意する。",
                "卵焼き器に油小さじ1/2を加えて火にかける（隅や角にも油を流してなじませる）。",
                "火加減は終始弱めの中火で、箸先で卵液を落としたときにジュっと、一瞬で卵液が固まる熱さになっているかを確認する。",
                "卵液の1/3量ほどを入れて全体に広げ、焼けてきたら1回目は粗く巻いてOKなので、奥側に卵を巻いてまとめる（そのあとに手前にさっと油をひく）。",
                "残りの卵液の半量を空いたところに流し入れ、奥の卵の下に箸を入れて持ち上げ、卵焼きの下にも卵液を流し入れる。",
                "半熟より少し固まってきたタイミングで卵を巻き、卵を奥に移動する。残りの卵液を流し入れ、再び同じことを繰り返す。",
                "合計4、5回に分けて焼く。"
              ],
              memo:"xx",
              review:"xx"
            },
            {
              title: "マカロニサラダ",
              servings: 3,
              ingredients: [
                { ingredient: "マカロニ", amount: 100, unit: "g" },
                { ingredient: "ハム", amount: 100, unit: "g" },
                { ingredient: "玉ねぎ", amount: 1 / 3, unit: "個" },
                { ingredient: "ピクルス", amount: 5, unit: "本" },
                { ingredient: "ゆで卵", amount: 4, unit: "個" },
                { ingredient: "調味料A", amount: "", unit: "" },
                { ingredient: "マヨネーズ", amount: 4, unit: "大さじ" },
                { ingredient: "白ワインビネガー", amount: 1.5, unit: "小さじ" },
                { ingredient: "砂糖", amount: 1, unit: "小さじ" },
                {
                  ingredient: "塩・胡椒・粗挽き胡椒",
                  amount: "",
                  unit: "適宜",
                },
              ],
              cook: [
                "玉ねぎはスライサーで薄切りにし、水に晒して水気を絞る。ピクルスは2㎜の輪切りにする。ハムは食べ易い大きさに切る。",
                "マカロニを茹でる。表示時間の1.5倍茹で、ザルにあげ、粗熱を取る。",
                "ボウルに茹で卵を加えて粗く潰す。調味料Ａを加えて混ぜ合わせ、1・2も加えてザックリ混ぜる。",
                "器に盛り、粗挽き胡椒を振る。",
              ],
              memo:"xx",
              review:"xx"
            },
          ];

          // JSONに変換してローカルストレージへ保存
          localStorage.setItem("recipes", JSON.stringify(recipes));
          console.log("初期データをローカルストレージへ保存しました！");
        } else {
          console.log("ローカルストレージには既にデータがあります！");
        }
      });

      /***********************************************************************************************
      ボタンクリック時の処理 検索ボタン：search
      ***********************************************************************************************/
      $("#search").on("click", function () {
        // 検索開始をもって背景画像を変更
        $("#resultContainer").addClass("search-active");
        // 検索開始前に最新のレシピデータを取得
        const recipes = JSON.parse(localStorage.getItem("recipes")) || [];
        // 入力フォームの検索ワードを取得
        const searchWord = $("#searchWord").val().trim();

        // 検索ワードが空の場合は処理をしない
        if (searchWord === "") {
          alert("検索ワードを入力してください");
          console.log("検索ワードを入力してください");
          return;
        }

        // 検索ワードが含まれているレシピを抽出
        const matchedRecipes = recipes.filter(
          (recipe) =>
            recipe.title.includes(searchWord) ||
            (recipe.ingredients && recipe.ingredients.some((ing) =>
              ing.ingredient.includes(searchWord)
            )) ||
            (recipe.cook && recipe.cook.some((step) => step.includes(searchWord)))
        );

        // 検索結果のタイトルを表示

        if (matchedRecipes.length > 0) {
          const titles = matchedRecipes.map((recipe) => recipe.title);
          console.log("ヒットしたレシピ:", titles.join(", "));
          $("#resultContainer").html("<ul></ul>");
          matchedRecipes.forEach((recipe) => {
            $("#resultContainer ul").append(
              `<li class="text-lg font-bold p-2 rounded-lg">
                <button class="recipe-item text-blue-600 underline" data-title="${recipe.title}">
                  ${recipe.title} （${recipe.servings}人前）
                </button>
              </li>`
            );
          });
        } else {
          console.log("検索ワードにはヒットしませんでした");
          alert("検索ワードにはヒットしませんでした");
        }
      });

      /***********************************************************************************************
      ボタンクリック時の処理 検索結果で表示されたメニューの選択：.recipe-item
      ***********************************************************************************************/
      $(document).on("click", ".recipe-item", function () {
        const selectedTitle = $(this).data("title"); // クリックされたメニューのタイトルを取得

        // 最新のレシピデータを取得（毎回最新データを検索）
        const recipes = JSON.parse(localStorage.getItem("recipes")) || [];

        // 選択されたメニューの詳細情報を検索
        const selectedRecipe = recipes.find(function (recipe) {
          return recipe.title === selectedTitle;
        });

        if (selectedRecipe) {
          displayRecipeDetails(selectedRecipe); // 詳細画面に情報をセット
          goToScreen3(); // メニュー詳細画面へ遷移
        }
      });

      /***********************************************************************************************
      ボタンクリック時の処理 検索ワードのクリア：wordClear
      ***********************************************************************************************/
      $("#wordClear").on("click", function () {
        $("#searchWord").val("");
        // 検索結果を完全にクリア
        $("#resultContainer").html("");
        // 検索終了をもって背景画像を戻し
        $("#resultContainer").removeClass("search-active");
      });

      /***********************************************************************************************
      ボタンクリック時の処理 新規メニュー登録：register
      ***********************************************************************************************/
      $(document).ready(function () {
        $("#register").on("click", function () {
          saveRecipe(); // メニューを保存
          clearForm(); // フォームをクリア
        });
      });

      function saveRecipe() {
        let title = $("#titleInput").val();
        let servings = $("#servingsInput").val();

        let ingredients = [];
        $("#ingredientsBody tr").each(function () {
          let ingredient = $(this).find("input:eq(0)").val();//配列の一つ目の要素の値を取得
          let amount = $(this).find("input:eq(1)").val();//二つ目の要素の値を取得
          let unit = $(this).find("input:eq(2)").val();//三つ目の要素の値を取得
          if (ingredient) {
            ingredients.push({ ingredient, amount, unit });
          }
        });

        let cookSteps = [];
        $("#cooksBody tr").each(function () {
          let step = $(this).find("textarea").val();
          if (step) {
            cookSteps.push(step);
          }
        });

        let newRecipe = {
          title,
          servings,
          ingredients,
          cook: cookSteps
        };

        let recipes = JSON.parse(localStorage.getItem("recipes")) || [];
        recipes.push(newRecipe);
        localStorage.setItem("recipes", JSON.stringify(recipes));

        alert("レシピが保存されました！"); // 成功メッセージ
      }

        function clearForm() {
          $("#titleInput, #servingsInput").val(""); // タイトルと人数をクリア
          $("#ingredientsBody, #cooksBody").empty(); // 食材・調味料と調理工程の行を削除
        }

      /***********************************************************************************************
      関数定義：画面間の移動
      ***********************************************************************************************/
      // 初期画面➡新規メニュー登録画面
      function goToScreen4() {
        $("#screen1").addClass("hidden");
        $("#screen4").removeClass("hidden");
      }

      // 初期画面➡メニュー検索画面
      function goToScreen2() {
        $("#screen1").addClass("hidden");
        $("#screen3").addClass("hidden");
        $("#screen2").removeClass("hidden");
      }

      // メニュー検索画面➡メニュー表示画面
      function goToScreen3() {
        $("#screen2").addClass("hidden");
        $("#screen3").removeClass("hidden");
      }

      // 各画面➡初期画面（最初に戻る）
      function goToScreen1() {
        $("#screen2").addClass("hidden");
        $("#screen3").addClass("hidden");
        $("#screen4").addClass("hidden");
        $("#screen1").removeClass("hidden");
      }

      /***********************************************************************************************
      関数定義：選択メニューの表示
      ***********************************************************************************************/
      function displayRecipeDetails(recipe) {
        let html = `<h2 class="text-xl font-bold bg-pink-100">${recipe.title}</h2>`;
        html += `<p>人数: ${recipe.servings} 人前</p>`;
        html += `<h3 class="font-bold mt-2 bg-pink-100">食材:</h3><ul>`;

        recipe.ingredients.forEach((ing) => {
            let amountDisplay = ing.amount == null || ing.amount === "" 
                ? "" // 分量未設定なら何も表示しない
                : Number.isInteger(ing.amount) 
                  ? ing.amount // 整数ならそのまま
                  : parseFloat(ing.amount).toFixed(1); // 小数なら小数点第一位まで

            html += `<li>${ing.ingredient}: ${amountDisplay}${ing.unit}</li>`;
        });

        html += `</ul><h3 class="font-bold mt-2 bg-pink-100">作り方:</h3><ol class="text-left">`;

        recipe.cook.forEach((step) => {
          html += `<li class="px-2">${step}</li>`;
        });
        console.log(recipe.cook); // cook配列が正しく入っているかチェック
        

        html += `</ol>`;

        html += `<p class="font-bold mt-2 bg-pink-100">メモ:</p>`;
        html += `<p class="text-left"> ${recipe.memo} </p>`;
        html += `<p class="font-bold mt-2 bg-pink-100">評価:</p>`;
        html += `<p> ${recipe.review} </p>`;
        $("#menuDetails").html(html).removeClass("hidden"); // メニュー情報を追加＆表示
      }

      /***********************************************************************************************
      関数定義：新規メニュー登録（食材・調味料の登録行追加・削除）
      ***********************************************************************************************/
      function addIngredientRow() {
        $("#ingredientsBody").append(`
          <tr>
            <td><input type="text" class="w-[80%] p-[5px]" placeholder="食材・調味料"></td>
            <td><input type="number" class="w-[80%] p-[5px]" placeholder="分量" step="0.01"></td>
            <td><input type="text" class="w-[80%] p-[5px]" placeholder="単位"></td>
            <td><button class="remove-btn bg-red-500 text-white px-3 py-1 rounded">削除</button></td>
          </tr>
        `);
      }

      $(document).on("click", ".remove-btn", function () {
        $(this).closest("tr").remove();
      });

      /***********************************************************************************************
      関数定義：新規メニュー登録（調理工程の登録行追加・削除）
      ***********************************************************************************************/
      function addCookRow() {
        $("#cooksBody").append(`
          <tr>
            <td><textarea class="w-full p-[5px] border border-gray-300 resize-y min-h-[100px]" placeholder="調理工程"></textarea></td>
            <td><button class="remove-btn bg-red-500 text-white px-3 py-1 rounded">削除</button></td>
          </tr>
        `);
      }

      $(document).on("click", ".remove-btn", function () {
        $(this).closest("tr").remove();
      });

    </script>
  </body>
</html>